<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BrinX - Notifications</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body class="bg-dark min-h-screen">
    <div id="star-field" class="star-field"></div>

    <nav class="glass-card mx-4 my-4 sticky top-4 z-50">
      <div class="container mx-auto px-6 py-4">
        <div class="flex justify-between items-center">
          <h1 class="text-3xl font-black gradient-text">
            Brin<span id="logo-x">X</span>
          </h1>
          <div class="hidden md:flex items-center space-x-2">
            <a href="dashboard.html" class="nav-link">Home</a>
            <a href="post-request.html" class="nav-link">Post Request</a>
            <a href="view-requests.html" class="nav-link">View Requests</a>
            <a href="assigned-tasks.html" class="nav-link">Assigned Tasks</a>
            <button
              id="logout-btn"
              class="bg-red-500 bg-opacity-20 border border-red-500 text-red-300 px-5 py-2 rounded-lg font-bold hover:bg-opacity-30"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-10 relative z-10">
      <div class="max-w-3xl mx-auto">
        <div class="flex justify-between items-center mb-10">
          <div>
            <h2 class="text-5xl font-black gradient-text mb-3">
              Notifications
            </h2>
            <p class="text-gray-400 text-lg">Stay updated with your tasks</p>
          </div>
          <button id="mark-all-read" class="btn-primary px-6 py-3">
            Mark All Read
          </button>
        </div>

        <div id="notifications-container" class="space-y-4">
          <div class="text-center py-16">
            <div class="text-6xl mb-4">‚è≥</div>
            <p class="text-gray-400 font-medium text-lg">
              Loading notifications...
            </p>
          </div>
        </div>
      </div>
    </div>

    <script src="js/stars.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/api.js"></script>
    <script>
      if (!localStorage.getItem("token")) {
        window.location.href = "index.html";
      }

      async function loadNotifications() {
        try {
          const data = await apiCall("/notifications", "GET");
          const container = document.getElementById("notifications-container");

          if (data.notifications.length === 0) {
            container.innerHTML = `
                        <div class="glass-card p-16 text-center">
                            <div class="text-6xl mb-6">üîî</div>
                            <p class="text-gray-400 text-xl font-bold mb-2">No notifications yet</p>
                            <p class="text-gray-500">You'll see updates about your tasks here</p>
                        </div>
                    `;
            return;
          }

          const notificationTypes = {
            task_posted: { icon: "üì¢", color: "blue" },
            task_accepted: { icon: "‚úÖ", color: "green" },
            task_completed: { icon: "üéâ", color: "purple" },
            reward_reminder: { icon: "‚ö†Ô∏è", color: "orange" },
            reward_confirmed: { icon: "üí∞", color: "emerald" },
          };

          container.innerHTML = data.notifications
            .map((notif) => {
              const typeInfo = notificationTypes[notif.type] || {
                icon: "üìã",
                color: "gray",
              };
              const timestamp = new Date(notif.timestamp).toLocaleString();

              return `
                        <div class="glass-card p-6 ${
                          notif.read
                            ? "opacity-60"
                            : "border-l-4 border-purple-500"
                        }">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0 text-4xl">
                                    ${typeInfo.icon}
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start mb-2">
                                        <p class="text-white font-bold text-lg leading-tight pr-4">${
                                          notif.message
                                        }</p>
                                        ${
                                          !notif.read
                                            ? '<span class="badge badge-info ml-2">NEW</span>'
                                            : ""
                                        }
                                    </div>
                                    <p class="text-sm text-gray-400 font-medium mb-1">üïê ${timestamp}</p>
                                    <p class="text-xs text-gray-500">From: ${
                                      notif.sender_name
                                    }</p>
                                    ${
                                      !notif.read
                                        ? `
                                        <button onclick="markAsRead('${notif._id}')" class="mt-4 text-purple-400 text-sm hover:text-purple-300 font-bold">
                                            ‚úì Mark as read
                                        </button>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    `;
            })
            .join("");

          anime({
            targets: ".glass-card",
            translateX: [-50, 0],
            opacity: [0, 1],
            delay: anime.stagger(80),
            duration: 500,
            easing: "easeOutExpo",
          });
        } catch (error) {
          console.error("Error loading notifications:", error);
          document.getElementById("notifications-container").innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <p class="text-red-400 font-bold text-lg">Failed to load notifications</p>
                        <button onclick="loadNotifications()" class="mt-4 btn-primary px-6 py-2">
                            Try Again
                        </button>
                    </div>
                `;
        }
      }

      window.markAsRead = async function (notificationId) {
        try {
          await apiCall(`/notifications/${notificationId}/read`, "PATCH");
          loadNotifications();
        } catch (error) {
          console.error("Error marking as read:", error);
        }
      };

      document
        .getElementById("mark-all-read")
        .addEventListener("click", async () => {
          try {
            await apiCall("/notifications/mark-all-read", "PATCH");
            loadNotifications();
            alert("All notifications marked as read!");
          } catch (error) {
            console.error("Error:", error);
            alert("Failed to mark all as read");
          }
        });

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "index.html";
      });

      loadNotifications();
      setInterval(loadNotifications, 30000);
    </script>
  </body>
</html>
